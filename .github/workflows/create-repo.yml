name: Repo Factory - Create Repository

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "新仓库名（如 STD001-payment-api）"
        required: true
      codeowner:
        description: "Code Owner（team 名，如 release-payment）"
        required: true
      standard:
        description: "合规编号（如 STD001）"
        required: true

jobs:
  create-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Validate repository name
        id: validate
        run: |
          REPO_NAME="${{ github.event.inputs.repo_name }}"

          echo "Checking repo name: $REPO_NAME"

          # 规则 1：正则校验
          if ! [[ "$REPO_NAME" =~ ^STD[0-9]{3}-[a-z0-9-]+$ ]]; then
            echo "❌ 仓库名不符合命名规范"
            exit 1
          fi

          # 规则 2：长度限制
          if [ ${#REPO_NAME} -gt 50 ]; then
            echo "❌ 仓库名过长（>50）"
            exit 1
          fi

          # 规则 3：是否已存在
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.ORG_ADMIN_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository_owner }}/$REPO_NAME)

          if [ "$STATUS" == "200" ]; then
            echo "❌ 仓库已存在"
            exit 1
          fi

          echo "✅ 仓库名校验通过"

      - name: Create repository from template
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG_ADMIN_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/orgs/${{ github.repository_owner }}/repos \
            -d @- <<EOF
          {
            "name": "${{ github.event.inputs.repo_name }}",
            "private": true,
            "template_repository": {
              "owner": "${{ github.repository_owner }}",
              "name": "base-template"
            }
          }
          EOF

      - name: Dispatch init workflow to new repo
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG_ADMIN_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.inputs.repo_name }}/dispatches \
            -d @- <<EOF
          {
            "event_type": "repo-init",
            "client_payload": {
              "codeowner": "${{ github.event.inputs.codeowner }}",
              "standard": "${{ github.event.inputs.standard }}"
            }
          }
          EOF

name: Repo Factory - Create Repository

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      template_name:
        description: "テンプレートリポジトリ名"
        required: true
        default: "AEGIS_R_template_20260108_1"
      repo_name:
        description: "新しいリポジトリ名（例：AEGIS_S_STD001_xxxxxx）"
        required: true
        default: "AEGIS_S_STD001_xxxxxx"
      codeowner:
        description: "Code Owner（カンマ区切り）"
        required: true
        default: "jiangtestgm, suzhen-copilot"
      team_slug:
        description: "Team Slug（Team名ではありません）"
        required: true
        default: "test001"
      study_no:
        description: "StudyNo カスタムプロパティ値"
        required: true
        default: "STD001"

jobs:
  create-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CREATE_REPO_APP_ID }}
          private-key: ${{ secrets.CREATE_REPO_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Set GH_TOKEN
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> $GITHUB_ENV

      - name: Configure Target Branches
        run: |
          # ---------------------------------------------------
          # Configuration: Define extra branches here
          # ---------------------------------------------------
          # メインブランチ以外に作成するブランチ（スペース区切り）
          echo "OTHER_BRANCHES=dev qa" >> $GITHUB_ENV

      - name: 入力パラメータの検証
        id: validate
        run: |
          # ---------------------------------------------------
          # 1. テンプレートの存在チェック
          # ---------------------------------------------------
          TEMPLATE_NAME="${{ github.event.inputs.template_name }}"
          echo "テンプレートを検証中: $TEMPLATE_NAME"

          STATUS_TPL=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository_owner }}/$TEMPLATE_NAME)

          if [ "$STATUS_TPL" != "200" ]; then
            echo "❌ テンプレートリポジトリ($TEMPLATE_NAME)が見つかりません"
            exit 1
          fi
          echo "✅ テンプレート確認OK"

          # ---------------------------------------------------
          # 2. Code Ownerの存在チェック（組織メンバーであること）
          # ---------------------------------------------------
          INPUT_OWNERS="${{ github.event.inputs.codeowner }}"
          echo "Code Ownerを検証中（組織メンバーチェック）: $INPUT_OWNERS"

          # カンマで分割してループ
          CLEAN_OWNERS=$(echo "$INPUT_OWNERS" | tr ',' ' ' | xargs)

          for OWNER in $CLEAN_OWNERS; do
            echo "  Checking member: $OWNER"
            STATUS_USER=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/orgs/${{ github.repository_owner }}/members/$OWNER)
              
            if [ "$STATUS_USER" != "204" ]; then
              echo "❌ ユーザー($OWNER)は、組織(${{ github.repository_owner }})のメンバーではありません、または存在しません"
              exit 1
            fi
            # 注意: /orgs/{org}/members/{username} は、メンバーである場合 204 No Content を返します
            # メンバーでない場合 404 Not Found (または 302) を返します
          done
          echo "✅ Code Owner確認OK"

          # ---------------------------------------------------
          # 3. リポジトリ名のルールチェック
          # ---------------------------------------------------
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          echo "リポジトリ名を検証中: $REPO_NAME"

          # ルール 1：文字種チェック（英数字, _, - のみ）
          if ! [[ "$REPO_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "❌ リポジトリ名に使用できない文字が含まれています"
            exit 1
          fi

          # ルール 2：構成チェック（AEGIS_S_STD001_xxxxxx）
          # 第一部分: AEGIS
          # 第二部分: P or S
          # 第三部分: STD or PRO start
          if ! [[ "$REPO_NAME" =~ ^AEGIS_[PS]_(STD|PRO) ]]; then
             echo "❌ リポジトリ名の形式が正しくありません（例：AEGIS_S_STD001_xxxxxx）"
             exit 1
          fi

          # ルール 3：長さ制限 (Githubの推奨に従う、最大100文字とする)
          if [ ${#REPO_NAME} -gt 100 ]; then
            echo "❌ リポジトリ名が長すぎます（>100）"
            exit 1
          fi

          # ルール 4：既存在チェック
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository_owner }}/$REPO_NAME)

          if [ "$STATUS" == "200" ]; then
            echo "❌ リポジトリは既に存在します"
            exit 1
          fi

          echo "✅ 検証に合格しました"

      - name: テンプレートからリポジトリを作成
        run: |
          curl -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.inputs.template_name }}/generate \
            -d @- <<EOF
          {
            "name": "${{ github.event.inputs.repo_name }}",
            "owner": "${{ github.repository_owner }}",
            "private": false
          }
          EOF

      - name: リポジトリ作成完了待機 (Wait for creation)
        run: |
          TARGET_REPO="${{ github.repository_owner }}/${{ github.event.inputs.repo_name }}"
          echo "リポジトリの作成完了を待機中: $TARGET_REPO"

          MAX_RETRIES=10
          SLEEP_SEC=5

          for ((i=1; i<=MAX_RETRIES; i++)); do
            echo "Attempt $i/$MAX_RETRIES: Checking repo and main branch existence..."
            
            # リポジトリのmainブランチ情報を取得して存在確認 (200 OK なら作成完了とみなす)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/repos/$TARGET_REPO/branches/main)
            
            if [ "$HTTP_CODE" == "200" ]; then
              echo "✅ リポジトリ作成完了とmainブランチの存在を確認しました。"
              exit 0
            fi
            
            echo "Waiting ${SLEEP_SEC}s..."
            sleep $SLEEP_SEC
          done

          echo "❌ タイムアウト: リポジトリの作成を確認できませんでした。"
          exit 1

      - name: カスタムプロパティ (StudyNo) を設定
        run: |
          # Custom Property 設定 (PATCH /repos/{owner}/{repo}/custom-properties/values)
          # 注意: 事前にOrganization側で 'StudyNo' というプロパティが定義されている必要があります

          # APIバージョンヘッダーを追加して curl を実行
          curl -L \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/orgs/${{ github.repository_owner }}/properties/values \
            -d @- <<EOF
          {
            "repository_names": [
              "${{ github.event.inputs.repo_name }}"
            ],
            "properties": [
              {
                "property_name": "StudyNo",
                "value": "${{ github.event.inputs.study_no }}"
              }
            ]
          }
          EOF

      - name: TeamにWrite権限を付与
        run: |
          TEAM_SLUG="${{ github.event.inputs.team_slug }}"
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          OWNER="${{ github.repository_owner }}"

          echo "Assigning Write permission to team: $TEAM_SLUG for repo: $REPO_NAME"

          # チームに push (Write) 権限を付与
          # PUT /orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{"permission":"push"}' \
            "https://api.github.com/orgs/$OWNER/teams/$TEAM_SLUG/repos/$OWNER/$REPO_NAME")

          if [ "$STATUS" == "204" ]; then
            echo "✅ Team '$TEAM_SLUG' added with Write access."
          else
            echo "❌ Failed to add team. Status code: $STATUS"
            echo "   Check if team slug is correct and app has permissions."
            exit 1
          fi

      - name: CODEOWNERS作成とPush (Actions有効化)
        run: |
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          CODE_OWNER="${{ github.event.inputs.codeowner }}"

          echo "CODEOWNERSファイルを生成してPushします (Actionsのアクティベーションも兼ねる)"

          # 作業用ディレクトリ
          WORK_DIR="temp_work_$REPO_NAME"
          mkdir -p $WORK_DIR
          cd $WORK_DIR

          # 新リポジトリをclone (GH_TOKEN使用)
          git clone --depth 1 "https://x-access-token:$GH_TOKEN@github.com/${{ github.repository_owner }}/$REPO_NAME.git" .

          # CODEOWNERS生成
          # カンマをスペースに変換し、xargsで整形（前後空白削除）
          # Githubユーザー名に空白は含まれないため、xargsの空白圧縮も問題になりません
          CLEAN_OWNERS=$(echo "$CODE_OWNER" | tr ',' ' ' | xargs)

          # スペース区切りになったリストをループして @ を付与
          FORMATTED_OWNERS=""
          for owner in $CLEAN_OWNERS; do
            FORMATTED_OWNERS="$FORMATTED_OWNERS @$owner"
          done

          echo "# This file is automatically generated by Repo Factory" > .github/CODEOWNERS
          echo "*" $FORMATTED_OWNERS >> .github/CODEOWNERS

          # Commit & Push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .github/CODEOWNERS
          git commit -m "chore: setup CODEOWNERS and activate actions"
          git push origin main

          # ---------------------------------------------------
          # 分支作成: dev, qa... (基于main)
          # ---------------------------------------------------
          echo "Creating additional branches: ${{ env.OTHER_BRANCHES }}"

          for BRANCH in ${{ env.OTHER_BRANCHES }}; do
            echo "Creating branch: $BRANCH"
            git checkout -b $BRANCH
            git push origin $BRANCH
            # Reset to main for next branch creation (base on main)
            git checkout main
          done

          echo "✅ 分支作成完了"

          echo "✅ CODEOWNERSのPush完了。Actionsがアクティブ化されました。"

          # 後始末
          cd ..
          rm -rf $WORK_DIR

      - name: Rulesetの設定 (Import from file)
        run: |
          TARGET_REPO="${{ github.repository_owner }}/${{ github.event.inputs.repo_name }}"
          echo "Setting up rulesets for $TARGET_REPO"

          # ルールセット定義ファイルのディレクトリ
          FACTORY_REPO="${{ github.repository }}" 
          RULES_DIR=".github/rulesets"
          TARGET_BRANCHES="main ${{ env.OTHER_BRANCHES }}"

          echo "Target branches for rulesets: $TARGET_BRANCHES"

          for BRANCH in $TARGET_BRANCHES; do
            FILE="ruleset_${BRANCH}.jsonc"
            echo "---------------------------------------------------"
            echo "Checking ruleset file for branch: $BRANCH ($FILE)"
            
            CONTENT_URL="https://api.github.com/repos/$FACTORY_REPO/contents/$RULES_DIR/$FILE"
            
            # 存在確認
            FILE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" $CONTENT_URL)
            
            if [ "$FILE_STATUS" != "200" ]; then
              echo "ℹ️ No ruleset file found for '$BRANCH' (Status: $FILE_STATUS). Skipping."
              continue
            fi

            echo "✅ Found ruleset file for $BRANCH. Downloading..."
            
            # ダウンロード
            DOWNLOAD_RESP=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" $CONTENT_URL)
              
            if ! echo "$DOWNLOAD_RESP" | grep -q '"content":'; then
               echo "❌ Error: Failed to parse content for $FILE"
               continue
            fi
            
            # JSON抽出とデコード (jqを使用)
            echo "$DOWNLOAD_RESP" | jq -r .content | base64 -d > temp_ruleset.json
            
            # コメント削除と整形
            # sedで // 以降を削除。文字列内の // を誤検知するリスクがあるが、
            # 現在の定義ファイルにはURL等が含まれていないため許容する。
            sed 's|//.*||g' temp_ruleset.json > clean_ruleset.json

            echo "Creating ruleset for branch: $BRANCH..."
            
            # 作成実行 (レスポンスボディも取得してエラー詳細を表示)
            HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$TARGET_REPO/rulesets" \
              -d @clean_ruleset.json)

            # ステータスコードとボディを分離
            HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)
            HTTP_BODY=$(echo "$HTTP_RESPONSE" | sed '$d')
              
            if [ "$HTTP_CODE" == "201" ]; then
              echo "✅ Ruleset created for $BRANCH"
            else
              echo "❌ Failed to create ruleset for $BRANCH. Status: $HTTP_CODE"
              echo "⬇️ Error Response Body:"
              echo "$HTTP_BODY" | jq . || echo "$HTTP_BODY"
              # デバッグ用に送信したJSONを表示
              echo "⬇️ Sent JSON Payload (First 20 lines):"
              head -n 20 clean_ruleset.json
            fi
          done

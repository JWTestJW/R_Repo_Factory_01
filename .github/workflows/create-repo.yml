name: Repo Factory - Create Repository

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      template_name:
        description: "テンプレートリポジトリ名"
        required: true
      repo_name:
        description: "新しいリポジトリ名（例：AEGIS_S_STD001_xxxxxx）"
        required: true
      codeowner:
        description: "Code Owner（カンマ区切り）"
        required: true
      team_slug:
        description: "Team Slug（Team名ではありません）"
        required: true
      study_no:
        description: "Studyナンバー"
        required: true

jobs:
  create-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CREATE_REPO_APP_ID }}
          private-key: ${{ secrets.CREATE_REPO_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Set GH_TOKEN
        run: echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> $GITHUB_ENV

      - name: 入力パラメータの検証
        id: validate
        run: |
          # ---------------------------------------------------
          # 1. テンプレートの存在チェック
          # ---------------------------------------------------
          TEMPLATE_NAME="${{ github.event.inputs.template_name }}"
          echo "テンプレートを検証中: $TEMPLATE_NAME"

          STATUS_TPL=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository_owner }}/$TEMPLATE_NAME)

          if [ "$STATUS_TPL" != "200" ]; then
            echo "❌ テンプレートリポジトリ($TEMPLATE_NAME)が見つかりません"
            exit 1
          fi
          echo "✅ テンプレート確認OK"

          # ---------------------------------------------------
          # 2. Code Ownerの存在チェック（組織メンバーであること）
          # ---------------------------------------------------
          INPUT_OWNERS="${{ github.event.inputs.codeowner }}"
          echo "Code Ownerを検証中（組織メンバーチェック）: $INPUT_OWNERS"

          # カンマで分割してループ
          IFS=',' read -r -a OWNER_ARRAY <<< "$INPUT_OWNERS"
          for OWNER in "${OWNER_ARRAY[@]}"; do
            # 空白除去
            OWNER=$(echo "$OWNER" | xargs)
            if [ -z "$OWNER" ]; then continue; fi

            echo "  Checking member: $OWNER"
            STATUS_USER=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/orgs/${{ github.repository_owner }}/members/$OWNER)
              
            if [ "$STATUS_USER" != "204" ]; then
              echo "❌ ユーザー($OWNER)は、組織(${{ github.repository_owner }})のメンバーではありません、または存在しません"
              exit 1
            fi
            # 注意: /orgs/{org}/members/{username} は、メンバーである場合 204 No Content を返します
            # メンバーでない場合 404 Not Found (または 302) を返します
          done
          echo "✅ Code Owner確認OK"

          # ---------------------------------------------------
          # 3. リポジトリ名のルールチェック
          # ---------------------------------------------------
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          echo "リポジトリ名を検証中: $REPO_NAME"

          # ルール 1：文字種チェック（英数字, _, - のみ）
          if ! [[ "$REPO_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "❌ リポジトリ名に使用できない文字が含まれています"
            exit 1
          fi

          # ルール 2：構成チェック（AEGIS_S_STD001_xxxxxx）
          # 第一部分: AEGIS
          # 第二部分: P or S
          # 第三部分: STD or PRO start
          if ! [[ "$REPO_NAME" =~ ^AEGIS_[PS]_(STD|PRO) ]]; then
             echo "❌ リポジトリ名の形式が正しくありません（例：AEGIS_S_STD001_xxxxxx）"
             exit 1
          fi

          # ルール 3：長さ制限 (Githubの推奨に従う、最大100文字とする)
          if [ ${#REPO_NAME} -gt 100 ]; then
            echo "❌ リポジトリ名が長すぎます（>100）"
            exit 1
          fi

          # ルール 4：既存在チェック
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository_owner }}/$REPO_NAME)

          if [ "$STATUS" == "200" ]; then
            echo "❌ リポジトリは既に存在します"
            exit 1
          fi

          echo "✅ 検証に合格しました"

      - name: テンプレートからリポジトリを作成
        run: |
          curl -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.inputs.template_name }}/generate \
            -d @- <<EOF
          {
            "name": "${{ github.event.inputs.repo_name }}",
            "owner": "${{ github.repository_owner }}",
            "private": false
          }
          EOF

      - name: リポジトリ作成完了待機 (Wait for creation)
        run: |
          TARGET_REPO="${{ github.repository_owner }}/${{ github.event.inputs.repo_name }}"
          echo "リポジトリの作成完了を待機中: $TARGET_REPO"

          MAX_RETRIES=10
          SLEEP_SEC=5

          for ((i=1; i<=MAX_RETRIES; i++)); do
            echo "Attempt $i/$MAX_RETRIES: Checking repo existence..."
            
            # リポジトリの情報を取得して存在確認 (200 OK なら作成完了とみなす)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/repos/$TARGET_REPO)
            
            if [ "$HTTP_CODE" == "200" ]; then
              echo "✅ リポジトリ作成完了を確認しました。"
              exit 0
            fi
            
            echo "Waiting ${SLEEP_SEC}s..."
            sleep $SLEEP_SEC
          done

          echo "❌ タイムアウト: リポジトリの作成を確認できませんでした。"
          exit 1

      - name: カスタムプロパティ (StudyNo) を設定
        run: |
          # Custom Property 設定 (PATCH /repos/{owner}/{repo}/custom-properties/values)
          # 注意: 事前にOrganization側で 'StudyNo' というプロパティが定義されている必要があります

          # APIバージョンヘッダーを追加して curl を実行
          curl -L \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/orgs/${{ github.repository_owner }}/properties/values \
            -d @- <<EOF
          {
            "repository_names": [
              "${{ github.event.inputs.repo_name }}"
            ],
            "properties": [
              {
                "property_name": "StudyNo",
                "value": "${{ github.event.inputs.study_no }}"
              }
            ]
          }
          EOF

      - name: 新しいリポジトリへ初期化ワークフローをディスパッチ
        run: |
          TARGET_URL="https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.inputs.repo_name }}/dispatches"
          echo "Dispatching to: $TARGET_URL"

          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            $TARGET_URL \
            -d @- <<EOF
          {
            "event_type": "repo-init",
            "client_payload": {
              "codeowner": "${{ github.event.inputs.codeowner }}",
              "team_slug": "${{ github.event.inputs.team_slug }}",
              "study_no": "${{ github.event.inputs.study_no }}"
            }
          }
          EOF
          )

          if [ "$STATUS_CODE" == "204" ]; then
             echo "✅ Dispatch request accepted (204)."
             echo "⚠️ 注意: ワークフローが開始されない場合、テンプレートリポジトリに '.github/workflows/init-repo.yml' が存在するか確認してください。"
          else
             echo "❌ Dispatch failed with status: $STATUS_CODE"
             exit 1
          fi
